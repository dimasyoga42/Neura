export const buffMessage = `
Code buff\n> by Neura Bot
> use !report <nama buff, code buff> untuk menambahkan code buff mu kedalam bot
*Max HP*
- 2020096
- 1010032
- 1010084
- 1010356
- 1250015
- 2010228
- 3090618
- 3092003
- 3191130
- 3260178
- 54154629
- 6010062
- 6199999
*Max MP*
- 1010216
- 1011212
- 1020808
- 1027777
- 2010510
- 2020101
- 3017676
- 3204544
- 4261111
- 6053838
- 7100720
- 7150029
- 6060008
- 5111000
*AMPR*
- 1010017
- 1010596
- 1011010
- 1023040
- 1047777
- 1111000
- 3020777
- 3201003
- 4040404
- 4206969
- 4233333
- 5236969
- 7069420
- 7088807
- 7220777
- 8120000
- 4040088
- 1016969
ATK 
- 1119876
- 7170717
MATK 
- 1024649
- 1021684 Lv 9
STR 
- 1010055
- 1010968
- 1011069
- 1110033
- 2017890
- 2020303
- 2180000
- 4010024
- 5261919
- 7070777
- 2202202
- 2202202
- 1026234
DEX 
- 2020222 
- 1010058 
- 5010031 
- 4084545 
- 1010058 
- 5010092 
- 1010106 
- 7011001 
- 3111999
- 3220777
- 7012899
INT 
- 2020707 
- 6061294 
- 1010489 
- 6010701 
- 1032222 
- 1010140
- 1010498
- 1047777
- 2020707
- 7012899
AGI 
- 1220777
- 2020037
- 4262222
- 2010750
VIT 
- 5130123 Lv 9
- 2020909 Lv 9
- 4032850
CRITICAL RATE 
- 1069927 
- 1012000 
- 1010433 
- 3020108 
- 6065000 
- 7162029 
- 6022292 
- 1200069 
- 1010006 
- 1010092 
- 1010017 
- 1010050 
- 1011010 
- 1012000 
- 1100000 
ACCURACY 
- 4261111
- 1010013 Lv 9
- 7010077 Lv 9
- 3188000 Lv 8
WEAPON ATK
- 1010810
- 1011122
- 1180020
- 2020404
- 1010029 
- 1010099 
- 6010024 
- 1011126 
- 2020404 
- 2010136 
- 7050301 
- 1010810 
- 3081024 
-AGGRO 
- 1010147 
- 1016646 
- 6010009 
- 3010018 
- 1010038 
- 1010002 
+AGGRO 
- 6262000 
- 1010207 
- 3204544 
- 3158668 
- 1016646 
- 1264321 
- 2020606 
- 3053131 
- 1010297 
- 1140002 
- 3030110 
- 7171717 
- 3030110 
PHYSICAL RESIST 
- 3010034 
- 7010014 
- 6011415 Lv 9
- 4200069 Lv 9
- 6010701 Lv 9
- 1018989 Lv 9
- 3011999 Lv 9
- 1020001 
- 1010081 
- 1100000 
MAGICAL RESIST 
- 1111575 
- 2020505 
- 5200052 
- 1010004 
- 7010016 
- 7030023 
- 1100002 Lv 9
- 4080087 Lv 9
- 7227777 Lv 9
FRACTIONAL BARRIER 
- 1222002 Lv 8
- 6181999 Lv 8
- 6010062 Lv 8
- 6010062 Lv 8
- 7010082 Lv 10
DTE FIRE 
- 7088807 Lv 9
- 3210106 Lv 9
- 7011001 Lv 8
- 1010799 Lv 7
- 1012610 Lv 7
- 2010091 Lv 6
DTE WATER 
- 1023844 Lv 7
- 3010018 Lv 7
- 1110007 Lv 7
- 3226325 Lv 6
- 7150030 Lv 10
- 3210100 Lv 10
- 3062111 Lv 8
- 7011001 Lv 8
- 2260006 Lv 8
- 1110111 Lv 8
- 6070013 Lv 7
- 1010067 Lv 7
DTE EARTH 
- 3210103 Lv 10
- 2020202 Lv 9
- 1010216 Lv 8
- 1011111 Lv 8
- 2022222 Lv 8
- 4083005 Lv 8
- 2099876 Lv 7
- 1010174 Lv 7
- 5240001 Lv 7
- 3011143 Lv 7
- 1010002 Lv 6
- 5236969 Lv 6
DTE WIND 
- 1010055 Lv 7
- 3210101 Lv 9
- 3030303 Lv 8
- 3062111 Lv 8
- 1010055 Lv 7
- 4099876 Lv 7
DTE LIGHT 
- 3210105 Lv 10
- 1020345 Lv 9
- 4046666 Lv 8
- 4016699 Lv 6
DTE DARK 
- 1020345 Lv 9
- 3210106 Lv 9
- 5010092 Lv 9
- 6010003 Lv 8
- 1010006 Lv 7
- 1016646 Lv 7
- 1091111 Lv 7
- 3030069 Lv 7
- 1190020 Lv 10
- 5010092 Lv 9
- 3210104 Lv 10
- 3210105 Lv 9
DROP RATE 
- 1010084 Lv 6
- 4196969 Lv 6
- 4196969 Lv 6
DTE NEUTRAL 
- 3210102 Lv 10
- 3099876 Lv 7
- 1011902 Lv 7
- 6061294 Lv 7
- 1019696 Lv 6
- 1032727 Lv 5
━━━━━━━━━━━━━━━━━━━━`.trim();

// Function untuk search buff
export const searchBuff = (keyword) => {
  if (!keyword || keyword.trim() === "") {
    return null;
  }

  // Normalize keyword untuk pencarian
  const searchKey = keyword.trim().toUpperCase();

  // Parse buffMessage menjadi object
  const lines = buffMessage.split('\n');
  let currentCategory = "";
  const buffData = {};

  for (const line of lines) {
    const trimmedLine = line.trim();

    // Skip header dan footer
    if (trimmedLine.startsWith('Code buff') ||
      trimmedLine.startsWith('> by') ||
      trimmedLine.startsWith('> use') ||
      trimmedLine.startsWith('━')) {
      continue;
    }

    // Cek apakah ini kategori (dimulai dengan * atau huruf besar tanpa -)
    if (trimmedLine.startsWith('*') ||
      (trimmedLine.length > 0 &&
        !trimmedLine.startsWith('-') &&
        trimmedLine === trimmedLine.toUpperCase())) {
      // Bersihkan kategori dari *
      currentCategory = trimmedLine.replace(/\*/g, '').trim();
      buffData[currentCategory] = [];
    }
    // Cek apakah ini code buff (dimulai dengan -)
    else if (trimmedLine.startsWith('-')) {
      const code = trimmedLine.substring(1).trim();
      if (currentCategory && code) {
        buffData[currentCategory].push(code);
      }
    }
  }

  // Cari kategori yang cocok
  const matchedCategories = [];

  for (const [category, codes] of Object.entries(buffData)) {
    if (category.includes(searchKey)) {
      matchedCategories.push({
        category: category,
        codes: codes,
        exactMatch: category === searchKey
      });
    }
  }

  // Sort: exact match dulu, baru partial match
  matchedCategories.sort((a, b) => {
    if (a.exactMatch && !b.exactMatch) return -1;
    if (!a.exactMatch && b.exactMatch) return 1;
    return 0;
  });

  return matchedCategories.length > 0 ? matchedCategories : null;
};

// Function untuk WhatsApp bot
export const buff = async (sock, chatId, msg, args) => {
  try {
    // Jika tidak ada keyword, kirim semua buff
    if (!args || args.length === 0) {
      return sock.sendMessage(
        String(chatId),
        { text: buffMessage },
        msg ? { quoted: msg } : {}
      );
    }

    // Gabungkan args jadi satu keyword
    const keyword = args.join(' ');

    // Search buff
    const results = searchBuff(keyword);

    if (!results) {
      return sock.sendMessage(
        String(chatId),
        { text: `Buff "${keyword}" tidak ditemukan.\n\nGunakan !buff untuk melihat semua daftar buff.\n\nBy Neura Sama` },
        msg ? { quoted: msg } : {}
      );
    }

    // Format hasil
    let response = `TORAM BUFF - ${keyword.toUpperCase()}\n\n`;

    for (const result of results) {
      response += `${result.category}\n`;
      result.codes.forEach(code => {
        response += `- ${code}\n`;
      });
      response += `\n`;
    }

    response += `By Neura Sama`;

    await sock.sendMessage(
      String(chatId),
      { text: response },
      msg ? { quoted: msg } : {}
    );

  } catch (err) {
    console.error("Error in buff:", err);

    await sock.sendMessage(
      String(chatId),
      { text: `Gagal mencari buff.\nError: ${err.message}\n\nBy Neura Sama` },
      msg ? { quoted: msg } : {}
    );
  }
};
